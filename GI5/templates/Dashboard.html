{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Température & Humidité</title>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
</head>
<body>

<h1>Dashboard Température & Humidité (DHT11)</h1>

<div class="nav-links">
    <a href="{% url 'incidents' %}">Voir la page d'archives des incidents</a>
    <span style="margin: 0 10px;">|</span>
    {% if user.is_authenticated %}
        <a href="{% url 'admin:index' %}">Interface Admin Django</a>
        <span style="margin: 0 10px;">|</span>
        <a href="{% url 'logout' %}" style="color: #dc2626;">Déconnexion</a>
    {% else %}
        <a href="{% url 'login' %}">Connexion Admin</a>
    {% endif %}
</div>

<div class="cards-container">
    <div class="card">
        <div class="card-title">Température</div>
        <div class="value" id="temp-value">-- °C</div>
        <div class="time" id="temp-time">--</div>
        <button onclick="location.href='/graph_temp/'">Voir graphe température</button>
    </div>

    <div class="card">
        <div class="card-title">Humidité</div>
        <div class="value" id="hum-value">-- %</div>
        <div class="time" id="hum-time">--</div>
        <button onclick="location.href='/graph_hum/'">Voir graphe humidité</button>
    </div>

    <div class="card">
        <div class="card-title">Incidents</div>
        <div id="incident-status" class="value small">--</div>
        <div class="time" id="incident-detail">Aucun incident</div>
        <button onclick="location.href='/incidents/'">Voir les incidents</button>
    </div>

    <div class="card">
        <div class="card-title">Tester l'API (POST)</div>
        <form id="manual-form" style="flex: 1; display: flex; flex-direction: column;">
            {% csrf_token %}
            <label>Température (°C)</label>
            <input type="number" step="0.1" id="manual-temp" required>
            <label>Humidité (%)</label>
            <input type="number" step="0.1" id="manual-hum" required>
            <button type="submit" style="margin-top: auto;">Envoyer vers /api/post/</button>
        </form>
        <div id="manual-result" class="time"></div>
    </div>
</div>

<script>
    // Token CSRF depuis Django
    const CSRF_TOKEN = '{{ csrf_token }}';
    
    // Fonction pour récupérer le token CSRF depuis le cookie (fallback)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
<script src="{% static 'js/dashboard.js' %}"></script>
</body>
</html>
